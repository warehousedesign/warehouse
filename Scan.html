<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‰ªìÂ∫ìÊ†∏ÂØπÂä©Êâã</title>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 20px; background: #f4f7f9; text-align: center; }
        #scan-form { margin-bottom: 15px; }
        #scan-input { 
            width: 90%; padding: 18px; font-size: 1.4rem; border: 2px solid #007bff; 
            border-radius: 10px; outline: none; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .info-card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); text-align: left; }
        #package-title { font-size: 1.3rem; font-weight: bold; color: #007bff; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        .sku-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f0f0f0; }
        .sku-name { font-size: 1.1rem; flex: 1; }
        .status-icons { font-size: 1.6rem; flex: 1; text-align: right; letter-spacing: 5px; }
        #loading-msg { color: #666; display: none; margin-bottom: 10px; }
    </style>
</head>
<body>
    <h2>üì¶ Êâ´Á†ÅÊ†∏ÂØπÁ≥ªÁªü</h2>
    
    <form id="scan-form" onsubmit="return false;">
        <input type="text" id="scan-input" placeholder="ËØ∑Êâ´Á†ÅÈù¢ÂçïÊàñÂïÜÂìÅ..." autocomplete="off" autofocus>
    </form>
    <div id="loading-msg">Ê≠£Âú®ÂêåÊ≠•Ë°®Ê†ºÊï∞ÊçÆÔºåËØ∑Á®çÂÄô...</div>

    <div id="display-area" class="info-card" style="display:none;">
        <div id="package-title">Èù¢Âçï: <span id="current-tracking">---</span></div>
        <div id="sku-list"></div>
    </div>

    <script>
        // „ÄêËØ∑Âú®Ê≠§Â§ÑÊõøÊç¢‰∏∫‰Ω†ÈÉ®ÁΩ≤ÂêéÁöÑÊúÄÊñ∞ Web Â∫îÁî® URL„Äë
        const API_URL = "https://script.google.com/macros/s/AKfycby_FFz6_YZR0_e-oBAXn6WOCi2iVx63HyVDwsiXZ5Vm9rf063F8JBMMufRPKh5qEenJUQ/exec";
        
        let taskData = [];
        let currentOrder = [];
        let currentTracking = "";
        const input = document.getElementById('scan-input');
        const loading = document.getElementById('loading-msg');

        // Ëá™Âä®ËÅöÁÑ¶ÔºåËß£ÊîæÊâãÊåáÁÇπÂáª
        document.addEventListener('click', () => input.focus());
        setInterval(() => { if(document.activeElement !== input) input.focus(); }, 1000);

        input.addEventListener('keypress', async (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); // ÈòªÊ≠¢ÈªòËÆ§ÁöÑÂõûËΩ¶Âà∑Êñ∞Ë°å‰∏∫
                const val = input.value.trim();
                input.value = '';
                if (val) await handleScan(val);
            }
        });

        async function handleScan(code) {
            // ËØÜÂà´‰∏∫Èù¢Âçï (Ê†πÊçÆ‰Ω†ÂõæÁâá GFUS ÂºÄÂ§¥‰∏îÈïøÂ∫¶ËæÉÈïøÂà§Êñ≠)
            if (code.length > 10 || code.startsWith("GFUS")) {
                loading.style.display = 'block';
                try {
                    const res = await fetch(API_URL);
                    taskData = await res.json();
                    currentTracking = code;
                    
                    // ÂåπÈÖçÈÄªËæëÔºöCÂàó(index 2)‰∏∫ Tracking NoÔºåBÂàó(index 1)‰∏∫ Merchant SKU
                    currentOrder = taskData.filter(r => String(r[2]).trim() === code).map(r => ({
                        sku: String(r[1]).trim(), 
                        qty: parseInt(r[4] || r[3]), // ÂÖºÂÆπ‰Ω†Ë°®Ê†º DÊàñEÂàóÁöÑÊï∞Èáè
                        scanned: 0, 
                        icons: ""
                    }));

                    if (currentOrder.length > 0) {
                        document.getElementById('display-area').style.display = 'block';
                        document.getElementById('current-tracking').innerText = code;
                        render();
                        play("ting");
                    } else {
                        alert("Ë°®Ê†º‰ªªÂä°‰∏≠Êú™ÊâæÂà∞ËØ•ÂçïÂè∑ÔºÅ");
                    }
                } catch (err) {
                    alert("Êï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÊàñ API ÈìæÊé•");
                } finally {
                    loading.style.display = 'none';
                }
            } 
            // ËØÜÂà´‰∏∫ÂïÜÂìÅ SKU
            else if (currentTracking) {
                let item = currentOrder.find(i => i.sku === code && i.scanned < i.qty);
                if (item) {
                    item.scanned++;
                    item.icons += "‚úÖ"; // Ê≠£Á°ÆÊòæÁ§∫ÂØπÂè∑
                    play("ting");
                    log(code, "ÊàêÂäü", "‚úÖ");
                    if (currentOrder.every(i => i.scanned >= i.qty)) speak("‰Ω†ÁúüÊ£íÔºÅ");
                } else {
                    if (navigator.vibrate) navigator.vibrate(400); // ÈîôËØØÈúáÂä®ÊèêÈÜí
                    play("error");
                    let target = currentOrder.find(i => i.sku === code) || currentOrder[0];
                    target.icons += "‚ùå"; // ÈîôËØØÊòæÁ§∫ÂèâÂè∑‰∏î‰∏çÊ∂àÂ§±
                    log(code, "Â§±Ë¥•", "‚ùå");
                }
                render();
            }
        }

        function render() {
            document.getElementById('sku-list').innerHTML = currentOrder.map(i => `
                <div class="sku-row">
                    <div class="sku-name">${i.sku} (ÈúÄ${i.qty})</div>
                    <div class="status-icons">${i.icons}</div>
                </div>
            `).join('');
        }

        function play(type) {
            const ting = new Audio('https://actions.google.com/sounds/v1/foley/beeps_short_confirm_cluster.ogg');
            const err = new Audio('https://actions.google.com/sounds/v1/alarms/alarm_clock_short.ogg');
            type === "ting" ? ting.play() : err.play();
        }

        function speak(t) {
            const m = new SpeechSynthesisUtterance(t);
            m.lang = 'zh-CN';
            window.speechSynthesis.speak(m);
        }

        function log(sku, res, det) {
            fetch(API_URL, { 
                method: 'POST', 
                mode: 'no-cors', 
                body: JSON.stringify({
                    tracking: currentTracking, 
                    sku: sku, 
                    status: res, 
                    detail: det
                })
            });
        }
    </script>
</body>
</html>
