<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä»“åº“æ ¸å¯¹åŠ©æ‰‹-ç²¾å‡†å®šä½ç‰ˆ</title>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 20px; background: #f4f7f9; text-align: center; }
        #scan-input { width: 90%; padding: 18px; font-size: 1.4rem; border: 2px solid #007bff; border-radius: 10px; outline: none; }
        .info-card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); text-align: left; margin-top: 20px; }
        #package-title { font-size: 1.3rem; font-weight: bold; color: #007bff; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        .sku-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f0f0f0; }
        .status-icons { font-size: 1.6rem; letter-spacing: 5px; }
    </style>
</head>
<body>
    <h2>ğŸ“¦ ä»“åº“ç²¾å‡†æ ¸å¯¹ç³»ç»Ÿ</h2>
    <input type="text" id="scan-input" placeholder="è¯·æ‰«ç é¢å•æˆ–å•†å“..." autofocus>
    <div id="loading-msg" style="display:none; color: #666; margin: 10px;">ğŸ” æ­£åœ¨æ ¹æ®è¡¨å¤´å®šä½æ•°æ®...</div>

    <div id="display-area" class="info-card" style="display:none;">
        <div id="package-title">é¢å•: <span id="current-tracking">---</span></div>
        <div id="sku-list"></div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbz8QyB6qtMtgeVF3IVFfoL0wjLiFRRHjaoyOa48hRGlc_xecJbRhpHunih6vlUwr9CH7g/exec";
        let taskData = [];
        let currentOrder = [];
        let currentTracking = "";
        const input = document.getElementById('scan-input');

        // è‡ªåŠ¨èšç„¦ï¼Œä¿æŠ¤æ‰‹æŒ‡
        document.addEventListener('click', () => input.focus());
        setInterval(() => { if(document.activeElement !== input) input.focus(); }, 1000);

        input.addEventListener('keypress', async (e) => {
            if (e.key === 'Enter') {
                const val = input.value.trim();
                input.value = '';
                if (val) await handleScan(val);
            }
        });

        async function handleScan(code) {
            // è¯†åˆ«ä¸ºé¢å•
            if (code.toUpperCase().includes("GFUS") || code.length > 10) {
                document.getElementById('loading-msg').style.display = 'block';
                try {
                    const res = await fetch(API_URL);
                    taskData = await res.json();
                    
                    const headers = taskData[0].map(h => String(h).trim().toLowerCase());
                    
                    // ç²¾å‡†å®šä½åˆ—åï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼Œå»é™¤ç©ºæ ¼ï¼‰
                    const tIdx = headers.indexOf("tracking no");
                    const sIdx = headers.indexOf("merchant sku");
                    const qIdx = headers.indexOf("product quantity");

                    if (tIdx === -1) {
                        alert("é”™è¯¯ï¼šåœ¨è¡¨æ ¼ç¬¬ä¸€è¡Œæ²¡æ‰¾åˆ°åä¸º 'Tracking No' çš„åˆ—ï¼\nå½“å‰è¡¨å¤´å†…å®¹ä¸º: " + taskData[0].join(" | "));
                        return;
                    }

                    // åŒ¹é…é€»è¾‘
                    const scanVal = code.replace(/\s/g, '').toUpperCase();
                    currentOrder = taskData.slice(1).filter(r => {
                        const cellVal = String(r[tIdx]).replace(/\s/g, '').toUpperCase();
                        return cellVal === scanVal || cellVal.includes(scanVal);
                    }).map(r => ({
                        sku: String(r[sIdx]).trim(),
                        qty: parseInt(r[qIdx] || 1),
                        scanned: 0,
                        icons: ""
                    }));

                    if (currentOrder.length > 0) {
                        currentTracking = code;
                        document.getElementById('display-area').style.display = 'block';
                        document.getElementById('current-tracking').innerText = code;
                        render();
                        play("ting");
                    } else {
                        alert("æ‰¾ä¸åˆ°å•å·: " + code + "\nè¯·æ£€æŸ¥è¯¥å•å·æ˜¯å¦å·²å¡«å…¥ " + (tIdx + 1) + " åˆ—ä¸­ã€‚");
                    }
                } catch (err) {
                    alert("ç½‘ç»œè¯·æ±‚å¤±è´¥");
                } finally {
                    document.getElementById('loading-msg').style.display = 'none';
                }
            } else if (currentTracking) {
                // SKU åŒ¹é…é€»è¾‘
                let item = currentOrder.find(i => i.sku === code && i.scanned < i.qty);
                if (item) {
                    item.scanned++;
                    item.icons += " âœ…";
                    play("ting");
                    if (currentOrder.every(i => i.scanned >= i.qty)) speak("ä½ çœŸæ£’ï¼");
                } else {
                    if (navigator.vibrate) navigator.vibrate(400);
                    play("error");
                    let target = currentOrder.find(i => i.sku === code) || currentOrder[0];
                    target.icons += " âŒ";
                }
                render();
            }
        }

        function render() {
            document.getElementById('sku-list').innerHTML = currentOrder.map(i => `
                <div class="sku-row">
                    <span>${i.sku} (éœ€${i.qty})</span>
                    <span class="status-icons">${i.icons}</span>
                </div>
            `).join('');
        }

        function play(type) {
            const ting = new Audio('https://actions.google.com/sounds/v1/foley/beeps_short_confirm_cluster.ogg');
            const err = new Audio('https://actions.google.com/sounds/v1/alarms/alarm_clock_short.ogg');
            type === "ting" ? ting.play() : err.play();
        }

        function speak(t) {
            const m = new SpeechSynthesisUtterance(t);
            m.lang = 'zh-CN';
            window.speechSynthesis.speak(m);
        }
    </script>
</body>
</html>
