<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä»“åº“æ ¸å¯¹åŠ©æ‰‹-ä¿®å¤ç‰ˆ</title>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 20px; background: #f4f7f9; text-align: center; }
        #scan-form { margin-bottom: 15px; }
        #scan-input { 
            width: 90%; padding: 18px; font-size: 1.4rem; border: 2px solid #007bff; 
            border-radius: 10px; outline: none; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .info-card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); text-align: left; }
        #package-title { font-size: 1.3rem; font-weight: bold; color: #007bff; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        .sku-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f0f0f0; }
        .sku-name { font-size: 1.1rem; flex: 1; }
        .status-icons { font-size: 1.6rem; flex: 1; text-align: right; letter-spacing: 5px; }
        #loading-msg { color: #666; display: none; margin-bottom: 10px; }
    </style>
</head>
<body>
    <h2>ğŸ“¦ æ‰«ç æ ¸å¯¹ç³»ç»Ÿ</h2>
    <form id="scan-form" onsubmit="return false;">
        <input type="text" id="scan-input" placeholder="è¯·æ‰«ç é¢å•æˆ–å•†å“..." autocomplete="off" autofocus>
    </form>
    <div id="loading-msg">ğŸ” æ­£åœ¨æ£€ç´¢è¿å•æ•°æ®ï¼Œè¯·ç¨å€™...</div>

    <div id="display-area" class="info-card" style="display:none;">
        <div id="package-title">é¢å•: <span id="current-tracking">---</span></div>
        <div id="sku-list"></div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbz8QyB6qtMtgeVF3IVFfoL0wjLiFRRHjaoyOa48hRGlc_xecJbRhpHunih6vlUwr9CH7g/exec";
        
        let taskData = [];
        let currentOrder = [];
        let currentTracking = "";
        const input = document.getElementById('scan-input');
        const loading = document.getElementById('loading-msg');

        document.addEventListener('click', () => input.focus());
        setInterval(() => { if(document.activeElement !== input) input.focus(); }, 1000);

        input.addEventListener('keypress', async (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const val = input.value.trim();
                input.value = '';
                if (val) await handleScan(val);
            }
        });

        async function handleScan(code) {
            // è‡ªåŠ¨è¯†åˆ«é¢å•ï¼šGFUSå¼€å¤´æˆ–é•¿åº¦å¤§äº12ä½
            if (code.startsWith("GFUS") || code.length > 12) {
                loading.style.display = 'block';
                try {
                    const res = await fetch(API_URL);
                    taskData = await res.json();
                    
                    // åŠ¨æ€å®šä½åˆ—ç´¢å¼•
                    const headers = taskData[0];
                    const trackingIdx = headers.indexOf("Tracking No");
                    const skuIdx = headers.indexOf("Merchant SKU");
                    const qtyIdx = headers.indexOf("Product Quantity");

                    if (trackingIdx === -1 || skuIdx === -1) {
                        alert("é”™è¯¯ï¼šè¡¨æ ¼ä¸­æ‰¾ä¸åˆ°åä¸º 'Tracking No' æˆ– 'Merchant SKU' çš„åˆ—ï¼");
                        return;
                    }

                    currentTracking = code;
                    // ä½¿ç”¨ trim() æ¶ˆé™¤æ•°æ®ä¸­å¯èƒ½å­˜åœ¨çš„ä¸å¯è§ç©ºæ ¼
                    currentOrder = taskData.slice(1).filter(r => String(r[trackingIdx]).trim() === code).map(r => ({
                        sku: String(r[skuIdx]).trim(), 
                        qty: parseInt(r[qtyIdx] || 1), 
                        scanned: 0, 
                        icons: ""
                    }));

                    if (currentOrder.length > 0) {
                        document.getElementById('display-area').style.display = 'block';
                        document.getElementById('current-tracking').innerText = code;
                        render();
                        play("ting");
                    } else {
                        alert("è¡¨æ ¼ä¸­æœªæ‰¾åˆ°è¯¥å•å·: " + code + "\nè¯·ç¡®è®¤æ•°æ®å·²ç²˜è´´åˆ°â€œä»»åŠ¡è¡¨â€ä¸­ã€‚");
                    }
                } catch (err) {
                    alert("è·å–æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œå’ŒAPIéƒ¨ç½²æƒé™ã€‚");
                } finally {
                    loading.style.display = 'none';
                }
            } 
            else if (currentTracking) {
                let item = currentOrder.find(i => i.sku === code && i.scanned < i.qty);
                if (item) {
                    item.scanned++;
                    item.icons += " âœ…";
                    play("ting");
                    log(code, "æˆåŠŸ", "âœ…");
                    if (currentOrder.every(i => i.scanned >= i.qty)) speak("ä½ çœŸæ£’ï¼");
                } else {
                    if (navigator.vibrate) navigator.vibrate(400);
                    play("error");
                    let target = currentOrder.find(i => i.sku === code) || currentOrder[0];
                    target.icons += " âŒ";
                    log(code, "å¤±è´¥", "âŒ");
                }
                render();
            }
        }

        function render() {
            document.getElementById('sku-list').innerHTML = currentOrder.map(i => `
                <div class="sku-row">
                    <div class="sku-name">${i.sku} (éœ€${i.qty})</div>
                    <div class="status-icons">${i.icons}</div>
                </div>
            `).join('');
        }

        function play(type) {
            const ting = new Audio('https://actions.google.com/sounds/v1/foley/beeps_short_confirm_cluster.ogg');
            const err = new Audio('https://actions.google.com/sounds/v1/alarms/alarm_clock_short.ogg');
            type === "ting" ? ting.play() : err.play();
        }

        function speak(t) {
            const m = new SpeechSynthesisUtterance(t);
            m.lang = 'zh-CN';
            window.speechSynthesis.speak(m);
        }

        function log(sku, res, det) {
            fetch(API_URL, { 
                method: 'POST', 
                mode: 'no-cors', 
                body: JSON.stringify({ tracking: currentTracking, sku: sku, status: res, detail: det })
            });
        }
    </script>
</body>
</html>
